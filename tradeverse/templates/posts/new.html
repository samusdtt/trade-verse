{% extends 'base.html' %}
{% block content %}
<h1 class="h4 mb-3">New Post</h1>
<form method="post" enctype="multipart/form-data" id="postForm">
	<div class="mb-3">
		<label class="form-label">Title</label>
		<input name="title" class="form-control" required>
	</div>
	<div class="mb-3">
		<label class="form-label">Category</label>
		<select name="category_id" class="form-select" required>
			<option value="" disabled selected>Select a category</option>
			{% for c in categories %}
			<option value="{{ c.id }}">{{ c.name }}</option>
			{% endfor %}
		</select>
	</div>
	<div class="mb-3">
		<label class="form-label">Excerpt (optional)</label>
		<input name="excerpt" class="form-control" maxlength="300" placeholder="Short summary shown on cards">
	</div>
	<div class="mb-3">
		<label class="form-label">Tags (optional)</label>
		<input name="tags" class="form-control" placeholder="Enter tags separated by commas (e.g., trading, strategy, psychology)">
		<div class="form-text">Tags help others find your post</div>
	</div>
	<div class="mb-2">
		<label class="form-label d-flex align-items-center justify-content-between">
			<span>Content</span>
			<small class="text-muted">Rich editor: headings, bold, lists, links, quotes, code</small>
		</label>
		<div id="editor" style="height: 320px; background: #fff;" class="border rounded"></div>
		<input type="hidden" name="content" id="contentHtml">
	</div>
	<div class="row g-3">
		<div class="col-md-6">
			<label class="form-label">Thumbnail (JPG/PNG/WEBP)</label>
			<input type="file" name="thumbnail" accept="image/*" class="form-control" id="thumbnailInput">
		</div>
		<div class="col-md-6">
			<label class="form-label">Attach PDF (optional)</label>
			<input type="file" name="pdf" accept="application/pdf" class="form-control">
		</div>
	</div>
	<div class="mb-3">
		<label class="form-label">Status</label>
		<select name="status" class="form-select">
			<option value="published">Publish Now</option>
			<option value="draft">Save as Draft</option>
		</select>
	</div>
	<div class="mt-3">
		<button class="btn btn-primary">Create Post</button>
		<button type="button" class="btn btn-outline-secondary ms-2" onclick="saveAsDraft()">Save as Draft</button>
	</div>
</form>

<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script>
	(function(){
		var quill = new Quill('#editor', {
			theme: 'snow',
			placeholder: 'Write your post here...',
			modules: {
				toolbar: [
					[{ header: [1, 2, 3, false] }],
					['bold', 'italic', 'underline', 'strike'],
					[{ 'list': 'ordered'}, { 'list': 'bullet' }],
					['blockquote', 'code-block'],
					['link', 'image'],
					['clean']
				]
			}
		});

		// Debug thumbnail selection
		document.getElementById('thumbnailInput').addEventListener('change', function(e) {
			console.log('Thumbnail selected:', e.target.files[0]);
		});

		// Upload images pasted/selected into Quill
		function uploadImage(file) {
			var formData = new FormData();
			formData.append('image', file);
			return fetch("{{ url_for('posts.upload_image') }}", { method: 'POST', body: formData })
				.then(r => r.json());
		}
		quill.getModule('toolbar').addHandler('image', function() {
			var input = document.createElement('input');
			input.type = 'file';
			input.accept = 'image/*';
			input.onchange = function() {
				var file = input.files[0];
				uploadImage(file).then(function(res){
					if(res && res.url){
						var range = quill.getSelection(true);
						quill.insertEmbed(range.index, 'image', res.url, 'user');
					}
				});
			};
			input.click();
		});

		var form = document.getElementById('postForm');
		form.addEventListener('submit', function(){
			document.getElementById('contentHtml').value = quill.root.innerHTML;
		});

		function saveAsDraft() {
			document.querySelector('select[name="status"]').value = 'draft';
			document.getElementById('contentHtml').value = quill.root.innerHTML;
			form.submit();
		}
	})();
</script>
{% endblock %}