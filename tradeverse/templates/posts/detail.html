{% extends 'base.html' %}
{% block content %}
<article class="post-detail">
	<header class="mb-3">
		<div class="d-flex justify-content-between align-items-start">
			<div>
				<h1 class="h3 mb-2">{{ post.title }}</h1>
				<div class="text-muted small">
					By <a href="#" class="text-decoration-none">{{ post.author.name or post.author.username }}</a> 
					â€¢ {{ post.category.name }} â€¢ {{ post.created_at.strftime('%b %d, %Y') }}
					â€¢ <i class="bi bi-eye"></i> {{ post.views_count }} views
					â€¢ <i class="bi bi-clock"></i> {{ post.reading_time }} min read
				</div>
			</div>
			{% if current_user.is_authenticated and (current_user.is_admin or current_user.id == post.user_id) %}
			<div class="btn-group">
				<a href="{{ url_for('posts.edit_post', post_id=post.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
				<button type="button" class="btn btn-sm btn-outline-danger" onclick="deletePost()">Delete</button>
			</div>
			{% endif %}
		</div>
	</header>

	{% if post.thumbnail_path %}
	<div class="mb-3">
		<img src="{{ url_for('static', filename=post.thumbnail_path) }}" class="img-fluid rounded" alt="thumbnail" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
	</div>
	{% endif %}
	{% if not post.thumbnail_path or post.thumbnail_path is none %}
	<div class="mb-3">
		<div class="default-thumb rounded" style="height: 300px; font-size: 4rem;">
			<span>ðŸ“Š</span>
		</div>
	</div>
	{% endif %}

	{% if post.tags %}
	<div class="mb-3">
		{% for tag in post.tags.split(',') %}
		<span class="badge bg-light text-dark me-1">{{ tag.strip() }}</span>
		{% endfor %}
	</div>
	{% endif %}
	
	<div class="content lead">
		{{ post.content|embed_youtube|safe }}
	</div>

	<!-- Social Actions -->
	{% if current_user.is_authenticated %}
	<div class="social-actions mt-4 mb-3">
		<div class="d-flex gap-2">
			<button class="btn btn-outline-primary btn-sm" onclick="likePost()" id="likeBtn">
				<i class="bi bi-heart"></i> 
				<span id="likeText">{% if current_user.id in post.likes|map(attribute='user_id')|list %}Unlike{% else %}Like{% endif %}</span>
				<span id="likeCount" class="badge bg-secondary ms-1">{{ post.likes_count }}</span>
			</button>
			
			<button class="btn btn-outline-secondary btn-sm" onclick="bookmarkPost()" id="bookmarkBtn">
				<i class="bi bi-bookmark"></i> 
				<span id="bookmarkText">{% if current_user.id in post.bookmarks|map(attribute='user_id')|list %}Remove{% else %}Bookmark{% endif %}</span>
			</button>
			
			<div class="dropdown d-inline-block">
				<button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
					<i class="bi bi-list-ul"></i> Add to List
				</button>
				<ul class="dropdown-menu">
					{% for reading_list in current_user.reading_lists %}
					<li>
						<form method="POST" action="{{ url_for('posts.add_to_reading_list', list_id=reading_list.id, post_id=post.id) }}" style="display: inline;">
							<button type="submit" class="dropdown-item">
								{{ reading_list.name }}
							</button>
						</form>
					</li>
					{% endfor %}
					{% if current_user.reading_lists %}
					<li><hr class="dropdown-divider"></li>
					{% endif %}
					<li><a class="dropdown-item" href="{{ url_for('posts.new_reading_list') }}">Create New List</a></li>
				</ul>
			</div>

			{% if current_user.id != post.author.id %}
			<button class="btn btn-outline-info btn-sm" onclick="followUser({{ post.author.id }})" id="followBtn">
				<i class="bi bi-person-plus"></i> 
				<span id="followText">{% if current_user.id in post.author.followers|map(attribute='follower_id')|list %}Unfollow{% else %}Follow{% endif %}</span>
			</button>
			{% endif %}
		</div>
	</div>
	{% endif %}

	{% if post.pdf_path %}
	<div class="mt-4">
		<a class="btn btn-outline-primary" href="{{ url_for('static', filename=post.pdf_path) }}" target="_blank">Download PDF</a>
	</div>
	{% endif %}
	
	{% if current_user.is_authenticated and (current_user.is_admin or current_user.id == post.user_id) %}
	<div class="mt-4">
		<a href="{{ url_for('posts.export_post', post_id=post.id) }}" class="btn btn-outline-success">
			<i class="bi bi-download"></i> Export Post
		</a>
	</div>
	{% endif %}
</article>

<!-- Comments Section -->
<div class="comments-section mt-5">
	<h4>Comments ({{ post.comments|length }})</h4>
	
	{% if current_user.is_authenticated %}
	<form method="POST" action="{{ url_for('posts.add_comment', post_id=post.id) }}" class="mb-4">
		<div class="mb-3">
			<textarea name="content" class="form-control" rows="3" placeholder="Add a comment..." required></textarea>
		</div>
		<button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
	</form>
	{% else %}
	<div class="alert alert-info">
		<a href="{{ url_for('auth.login') }}">Login</a> to add comments.
	</div>
	{% endif %}

	<!-- Comments List -->
	<div class="comments-list">
		{% for comment in post.comments|sort(attribute='created_at', reverse=true) %}
		<div class="comment border-bottom pb-3 mb-3">
			<div class="d-flex justify-content-between align-items-start">
				<div class="flex-grow-1">
					<div class="d-flex align-items-center mb-1">
						<strong class="me-2">{{ comment.user.name or comment.user.username }}</strong>
						<small class="text-muted">{{ comment.created_at.strftime('%b %d, %Y at %I:%M %p') }}</small>
					</div>
					<div class="comment-content">
						{{ comment.content|nl2br }}
					</div>
				</div>
				{% if current_user.is_authenticated and (current_user.is_admin or current_user.id == comment.user_id) %}
				<form method="POST" action="{{ url_for('posts.delete_comment', comment_id=comment.id) }}" style="display: inline;">
					<button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this comment?')">
						<i class="bi bi-trash"></i>
					</button>
				</form>
				{% endif %}
			</div>
		</div>
		{% endfor %}
		
		{% if not post.comments %}
		<div class="text-muted text-center py-4">
			No comments yet. Be the first to comment!
		</div>
		{% endif %}
	</div>
</div>

<!-- Related Posts -->
{% if related_posts %}
<div class="related-posts mt-5">
	<h4>Related Posts</h4>
	<div class="row row-cols-1 row-cols-md-3 g-3">
		{% for related_post in related_posts %}
		<div class="col">
			<div class="card h-100">
				{% if related_post.thumbnail_path %}
				<img src="{{ url_for('static', filename=related_post.thumbnail_path) }}" class="card-img-top" style="height: 150px; object-fit: cover;" alt="thumbnail">
				{% endif %}
				<div class="card-body">
					<h6 class="card-title">{{ related_post.title }}</h6>
					<p class="card-text small text-muted">
						{{ related_post.created_at.strftime('%b %d, %Y') }}
						{% if related_post.series_order %}
						â€¢ Part {{ related_post.series_order }}
						{% endif %}
					</p>
					<a href="{{ url_for('posts.detail', post_id=related_post.id) }}" class="btn btn-sm btn-outline-primary">Read More</a>
				</div>
			</div>
		</div>
		{% endfor %}
	</div>
</div>
{% endif %}

{% if current_user.is_authenticated and (current_user.is_admin or current_user.id == post.user_id) %}
<form id="deleteForm" method="post" action="{{ url_for('posts.delete_post', post_id=post.id) }}" style="display:none;"></form>
{% endif %}

<script>
function deletePost() {
	if(confirm('Are you sure you want to delete this post?')) {
		document.getElementById('deleteForm').submit();
	}
}

function likePost() {
	fetch('{{ url_for("posts.like_post", post_id=post.id) }}', {
		method: 'POST',
		headers: {
			'X-Requested-With': 'XMLHttpRequest'
		}
	})
	.then(response => response.json())
	.then(data => {
		document.getElementById('likeText').textContent = data.is_liked ? 'Unlike' : 'Like';
		document.getElementById('likeCount').textContent = data.likes_count;
		document.getElementById('likeBtn').classList.toggle('btn-primary', data.is_liked);
		document.getElementById('likeBtn').classList.toggle('btn-outline-primary', !data.is_liked);
	});
}

function bookmarkPost() {
	fetch('{{ url_for("posts.bookmark_post", post_id=post.id) }}', {
		method: 'POST',
		headers: {
			'X-Requested-With': 'XMLHttpRequest'
		}
	})
	.then(response => response.json())
	.then(data => {
		document.getElementById('bookmarkText').textContent = data.is_bookmarked ? 'Remove' : 'Bookmark';
		document.getElementById('bookmarkBtn').classList.toggle('btn-secondary', data.is_bookmarked);
		document.getElementById('bookmarkBtn').classList.toggle('btn-outline-secondary', !data.is_bookmarked);
	});
}

function followUser(userId) {
	fetch(`/posts/user/${userId}/follow`, {
		method: 'POST',
		headers: {
			'X-Requested-With': 'XMLHttpRequest'
		}
	})
	.then(response => response.json())
	.then(data => {
		document.getElementById('followText').textContent = data.is_following ? 'Unfollow' : 'Follow';
		document.getElementById('followBtn').classList.toggle('btn-info', data.is_following);
		document.getElementById('followBtn').classList.toggle('btn-outline-info', !data.is_following);
	});
}
</script>

<style>
.comment-content {
	white-space: pre-wrap;
}
</style>
{% endblock %}