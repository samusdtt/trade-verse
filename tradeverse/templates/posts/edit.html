{% extends 'base.html' %}
{% block content %}
<h1 class="h4 mb-3">Edit Post</h1>
<form method="post" enctype="multipart/form-data" id="postForm">
	<div class="mb-3">
		<label class="form-label">Title</label>
		<input name="title" class="form-control" value="{{ post.title }}" required>
	</div>
	<div class="mb-3">
		<label class="form-label">Category</label>
		<select name="category_id" class="form-select" required>
			{% for c in categories %}
			<option value="{{ c.id }}" {% if post.category_id==c.id %}selected{% endif %}>{{ c.name }}</option>
			{% endfor %}
		</select>
	</div>
	<div class="mb-3">
		<label class="form-label">Excerpt (optional)</label>
		<input name="excerpt" class="form-control" maxlength="300" value="{{ post.excerpt or '' }}">
	</div>
	<div class="mb-2">
		<label class="form-label d-flex align-items-center justify-content-between">
			<span>Content</span>
			<small class="text-muted">Rich editor</small>
		</label>
		<div id="editor" style="height: 320px; background: #fff;" class="border rounded"></div>
		<input type="hidden" name="content" id="contentHtml">
	</div>
	<div class="row g-3">
		<div class="col-md-6">
			<label class="form-label">Thumbnail (JPG/PNG/WEBP)</label>
			<input type="file" name="thumbnail" accept="image/*" class="form-control">
			{% if post.thumbnail_path %}
			<small class="text-muted">Current: <img src="{{ url_for('static', filename=post.thumbnail_path) }}" alt="thumb" class="img-thumbnail mt-2" style="max-height:80px" onerror="this.style.display='none'"></small>
			{% endif %}
		</div>
		<div class="col-md-6">
			<label class="form-label">Attach PDF (optional)</label>
			<input type="file" name="pdf" accept="application/pdf" class="form-control">
			{% if post.pdf_path %}
			<small class="d-block mt-2"><a href="{{ url_for('static', filename=post.pdf_path) }}" target="_blank">View current PDF</a></small>
			{% endif %}
		</div>
	</div>
	<div class="mt-3">
		<button class="btn btn-primary">Save</button>
	</div>
</form>

<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script>
	(function(){
		var quill = new Quill('#editor', {
			theme: 'snow',
			modules: {
				toolbar: [
					[{ header: [1, 2, 3, false] }],
					['bold', 'italic', 'underline', 'strike'],
					[{ 'list': 'ordered'}, { 'list': 'bullet' }],
					['blockquote', 'code-block'],
					['link', 'image'],
					['clean']
				]
			}
		});
		quill.root.innerHTML = {{ post.content|tojson|safe }};

		// Upload images pasted/selected into Quill
		function uploadImage(file) {
			var formData = new FormData();
			formData.append('image', file);
			return fetch("{{ url_for('posts.upload_image') }}", { method: 'POST', body: formData })
				.then(r => r.json());
		}
		quill.getModule('toolbar').addHandler('image', function() {
			var input = document.createElement('input');
			input.type = 'file';
			input.accept = 'image/*';
			input.onchange = function() {
				var file = input.files[0];
				uploadImage(file).then(function(res){
					if(res && res.url){
						var range = quill.getSelection(true);
						quill.insertEmbed(range.index, 'image', res.url, 'user');
					}
				});
			};
			input.click();
		});

		var form = document.getElementById('postForm');
		form.addEventListener('submit', function(){
			document.getElementById('contentHtml').value = quill.root.innerHTML;
		});
	})();
</script>
{% endblock %}